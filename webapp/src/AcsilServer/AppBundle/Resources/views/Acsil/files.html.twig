{# Page for files' management #}
{% extends '::base.html.twig' %}

{#BLOCK TITRE#}
{% block title %}File Management{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	{% stylesheets filter='cssrewrite' '@AcsilServerAppBundle/Resources/public/css/*' %}
		<link href="{{ asset('public/css/bootstrap-fileupload.css') }}" rel="stylesheet" />
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css" media="all" rel="stylesheet" type="text/css"> {#font-awesome doesn't work on IE and FF so we have to use this one#}
		<link href="{{ asset('public/css/dropzone.css') }}" rel="stylesheet" />
		<link href="{{ asset('public/css/style.css') }}" rel="stylesheet" />
		<link href="{{ asset('public/css/style_responsive.css') }}" rel="stylesheet" />
		<link href="{{ asset('public/css/style_default.css') }}" rel="stylesheet"  id="style_color" />
		<link href="{{ asset('public/css/jquery.fancybox.css') }}" rel="stylesheet" />
		<link href="{{ asset('public/css/uniform.default.css') }}" rel="stylesheet" type="text/css"/> 
	{% endstylesheets %} 
{% endblock %}

{% block body %}
<script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
<script src="{{ path('fos_js_routing_js', {"callback": "fos.Router.setData"}) }}"></script>
	
	<div id="fileList" class="row-fluid">
		<h2>{{ 'Manage files'|trans }}</h2>
		
		<div id="addFile" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<h2>{{ 'Upload new document'|trans }}</h2>
			{% include 'AcsilServerAppBundle:Upload:upload.html.twig' %}
		</div><!-- addFile -->

		<div id="addFolder" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<h2>{{ 'Create new folder'|trans }}</h2>
			{% include 'AcsilServerAppBundle:Upload:folder.html.twig' %}
		</div><!-- addFolder -->
		
		<div id="shareFile" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<h2>{{ 'Share this document'|trans }}</h2>
			<div class="usersList">
				{% set totalUser = listusers|length - 1 %}
				[
					{% for key, user in listusers %}
					   {% if user.getEmail != app.user.email %}
							"{{ user.email }}"
							{% if key != totalUser %},{% endif %}
						{% endif %}
					{% endfor %}
				]
			</div><!-- userlist -->
			
			<h4>These users already have rights:</h4>
			<div id="sharedWith"></div><!-- sharedWith -->
			
			<h4>Give rights to user</h4>
			{% include 'AcsilServerAppBundle:Upload:ShareFile.html.twig' %}
		</div><!-- shareFile -->
		
		<div id="renameFile" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<p>	
			<h2>&nbsp{{ 'Rename this document'|trans }}</h2>
			{% include 'AcsilServerAppBundle:Upload:RenameFile.html.twig' %}
			</p>
		</div><!-- renameFile -->
		
		<div id="deleteFile" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<h2>{{ 'Delete file'|trans }}</h2>
			<p>
				<h4>{{ 'Are you sure you want to delete this file?'|trans }}</h4> <span class="foldername"></span>
				<a class="confirm btn btn-danger" href="">{{ 'Yes'|trans }}</a>
				<a class="noconfirm btn btn-primary" href="{{ path('_managefile', {'folderId': folderId|default(0)}) }}">{{ 'No'|trans }}</a>
			</p>
		</div><!-- deleteFolder -->
	<div id="deleteFolder" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<h2>{{ 'Delete folder'|trans }}</h2>
			<p>
				<h4>{{ 'Are you sure you want to delete this folder?'|trans }}</h4> <span class="filename"></span>
				<a class="confirm btn btn-danger" href="">{{ 'Yes'|trans }}</a>
				<a class="noconfirm btn btn-primary" href="{{ path('_managefile', {'folderId': folderId|default(0)}) }}">{{ 'No'|trans }}</a>
			</p>
		</div><!-- deleteFile -->
			<div class="row-fluid">
			<div class="span2">
				<ul class="nav nav-pills">
					<li class="active"><a href="#addFile" data-toggle="modal"><i class="icon-plus"></i> {{ 'Add file'|trans }} </a></li>
				</ul>
				<p>
					<ul>
						<li>You can add and manage as many files as you want as long as you have the correct rights to.</li>
						<li>You can also share files with users within your network.</li>
						<li>You can click on the 'Current path' chunks to get in which folder you want. </li>
						<li>A shared file is symbolized by a blue corner on the right top of the thumbnail. </li>						
					</ul>
				</p>
				</div><!-- span3 -->
			<div class="span2">
				<ul class="nav nav-pills">
					<li class="active"><a href="#addFolder" data-toggle="modal"><i class="icon-plus"></i> {{ 'Create folder'|trans }} </a></li>
				</ul>
				</div><!-- span3 -->
			<div class="span2">
				<ul class="nav nav-pills">
						<li class="active"><a href="{{ path('_pastefile', {'folderId': folderId|default(0)}) }}"><i class="icon-arrow-down"></i>{{ ' Paste'|trans }}</b></a></li>
				</ul>
				</div><!-- span3 -->
			<div class="span2">
				<ul class="nav nav-pills">
						<li class="active"><a href="{{ path('_managefile', {'folderId': parentId|default(0)}) }}"> <i class="icon-arrow-left"></i>{{ ' Back'|trans }}</b></a></li>
				</ul>
				</div><!-- span3 -->
			<div id="folderPath" class="span5">
				{{ "Current path : " | trans }}
				<a href="{{ path('_managefile', {'folderId': 0|default(0)}) }}">{{ "Root"|trans }}</b></a>
				/
				{% for key,value in parentIdList %}
					<a href="{{ path('_managefile', {'folderId': key|default(0)}) }}">{{ value|trans }}</b></a>
					/
				{% endfor %}
			</div><!-- folderPath -->
	
			<div id="itemList" class="span9 offset1">				
				
				{% for folder in listfolders %}
					<div class="userRow row-fluid">
						<div class="fileInfos span9">
							<div class="fileName span8">
							<div class="mini span2" style="width: 50px; height: 50px">
								<img src="{{asset('public/img/folder.png')}}" alt="lol"/>
							</div>
								&nbsp &nbsp
								<a href="{{ path('_managefile', {'folderId': folder.id|default(0)}) }}">{{ folder.name|trans }}</b></a>
							</div><!-- fileName -->
							<div class="fileSize span2">
								{{ folder.size}} file(s)
							</div>
							<div class="fileUploadDate span2">
								{{ folder.uploaddate|date }}
							</div><!-- file upload date -->
						</div><!-- fileInfos -->
						
						<div class="fileOptions span3">
							<div class="btn-group">
								<a class="btn btn-primary" href="#"><i class="icon-edit icon-white"></i> {{ 'Edit'|trans }}</a>
								<a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#"><span class="caret"></span></a>
								<ul class="dropdown-menu">
									{% if is_granted('VIEW', folder) %}
										<li><a href="{{ path('_download_folder', {'id': folder.id}) }}" target="_blank">
											<i class="icon-download-alt"></i> {{ 'Download'|trans }} </a>
										</li>
									{% endif %}
									{% if is_granted('EDIT', folder) %}
										<li> <a class="renamefolder" href="#renameFile" filename="{{ folder.name }}" fileid="{{ folder.id }}" data-toggle="modal">
												<i class="icon-font"></i> {{ 'Rename'|trans }} </a>
										</li>
										<li><a href="{{ path('_movefolder', {'id': folder.id, 'action': 0}) }}">
											<i class="icon-tag"></i> {{ 'Copy'|trans }} </a>
										</li>
										<li><a href="{{ path('_movefolder', {'id': folder.id, 'action': 1}) }}">
											<i class="icon-tag"></i> {{ 'Cut'|trans }} </a>
										</li>
									{% endif %}
									{% if is_granted('DELETE', folder) %}
										<li>
											<a class="deletefolder" href="{{ path('_delete_folder', {'id': folder.id}) }}" foldername="{{ folder.name }}" folderid="{{ folder.id }}" data-toggle="modal">
												<i class="icon-trash"></i> {{ 'Delete'|trans }} 
											</a>
										</li>
									{% endif %}
								</ul>
							</div><!-- btn group -->
						</div><!-- file options -->
					</div><!-- userRow -->
				{% endfor %}
				
				
				{% for document in listfiles %}
					<div class="userRow row-fluid">
						<div class="fileInfos span9">
							<div class="fileName span5">
						<div class="mini span2" style="width: 50px; height: 50px">			
						{#Display the image or a default image#}
						{% if (document.info.mimeType == "jpeg" or document.info.mimeType == "jpg" or document.info.mimeType == "png") or document.info.mimeType == "gif" %}
							<img id="miniImg" src="{{app.request.basepath}}/{{ document.info.getWebPath() }}" alt="img"/> 
						{% elseif document.info.mimeType == "mp3" or  document.info.mimeType == "mpga"%}
							<img id="miniImg" src="{{asset('public/img/music-mini.png')}}" alt="music"/>
						{% elseif document.info.mimeType == "avi" or document.info.mimeType == "mpeg4" or document.info.mimeType == "mp4"%}
							<img id="miniImg" src="{{asset('public/img/video-mini.png')}}" alt="video"/>							
						{% else %}
							<img id="miniImg" src="{{asset('public/img/document.png')}}" alt="file"/>
						{% endif %}
						
						{#Display an icon if the file is shared#}
						{% if document.info.isShared == 1 %}
							<img id="miniImgShare" src="{{asset('public/img/share-mini.png')}}" alt="lol"/>
						{% endif %}
						
							</div>
							&nbsp &nbsp
							<a href="{{app.request.basepath}}/{{ document.info.getWebPath() }}" target="_blank">
											{{ document.info.name|trans }}.{{ document.info.mimeType|trans }} </a>
							</div><!-- fileName -->
							<div class="fileSize span2">
								<div class="fileSize" >
									<b>	Size: </b>  
								</div>
								{{ document.info.formatedSize }}
							</div>
							<div class="fileUploadDate span2">
								<b> Upload date: </b> 
								{{ document.info.uploaddate|date }}
							</div><!-- file upload date -->
							<div class="fileUploadDate span3">
								<b> Last modifaction date: </b> 
								{{ document.info.lastmodifdate|date }}
							</div><!-- file upload date -->
						</div><!-- fileInfos -->
						
						<div class="fileOptions span3">
							{% if is_granted('OWNER', document.info) %}
							<a class="sharefile btn btn-primary" href="#shareFile" filename="{{ document.info.name }}" fileid="{{ document.info.id }}" data-toggle="modal">
								<i class="icon-user icon-white"></i> {{ 'Share'|trans }}
							</a>
							<div class="sharedWith">
								{% set totalUsers = document.sharedFileUserInfos|length %}
								{% if totalUsers > 0 %}
									[{% for key, sharedwith in document.sharedFileUserInfos %}
										{"id": "{{ sharedwith.user.id }}","email": "{{ sharedwith.user.email }}","rights": "{{ sharedwith.rights }}"} {% if totalUsers > key + 1 %},{% endif %}
									{% endfor %}]
								{% endif %}
							</div><!-- sharedWith -->
							{% endif %}
							<div class="btn-group">
								<a class="btn btn-primary" href="#"><i class="icon-edit icon-white"></i> {{ 'Edit'|trans }}</a>
								<a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#"><span class="caret"></span></a>
								<ul class="dropdown-menu">
									{% if is_granted('VIEW', document.info) %}
										<li><a href="{{ path('_download', {'id': document.info.id}) }}" target="_blank">
									
								{#		<li><a href="{{app.request.basepath}}/{{ document.info.getWebPath() }}" target="_blank"> #}
											<i class="icon-download-alt"></i> {{ 'Download'|trans }} </a>
										</li>
									{% endif %}
									{% if is_granted('EDIT', document.info) %}
										<li>
											<a class="renamefile" href="#renameFile" filename="{{ document.info.name }}" fileid="{{ document.info.id }}" data-toggle="modal">
												<i class="icon-font"></i> {{ 'Rename'|trans }} 
											</a>
										</li>
										<li><a href="{{ path('_movefile', {'id': document.info.id, 'action':0}) }}">
									
											<i class="icon-tags"></i> {{ 'Copy'|trans }} </a>
																	
										</li>
										<li><a href="{{ path('_movefile', {'id': document.info.id, 'action':1}) }}">
									
											<i class="icon-tag"></i> {{ 'Cut'|trans }} </a>
																	
										</li>
									{% endif %}
									{% if is_granted('DELETE', document.info) %}
										<li>
											<a class="deletefile" href="#deleteFile" filename="{{ document.info.name }}" fileid="{{ document.info.id }}" data-toggle="modal">
												<i class="icon-trash"></i> {{ 'Delete'|trans }} 
											</a>
										</li>
									{% endif %}
								</ul>
							</div><!-- btn group -->
						</div><!-- file options -->
					</div><!-- userRow -->
				{% endfor %}
			</div><!-- itemList -->
			
		</div><!-- row fluid -->
		
	</div><!-- fileList -->

{% endblock %}
